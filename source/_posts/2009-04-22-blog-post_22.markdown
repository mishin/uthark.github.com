---
layout: post
title: "Кратко о блокировках"
date: 2009-04-22T23:58:00+07:00
categories:
 - блокировка
 - разработка
---

<div class='post'>
<span style="font-weight: bold;">Блокировка</span> - в реляционных базах данных это установка метки на запись, что запись заблокирована для изменений.

Существует два вида блокировок - оптимистичная и пессимистичная.

<h3>Оптимистичная блокировка</h3>
При оптимистичной блокировке на базе данных реальной блокировки не происходит.
Вместо этого используется следующий подход - если во время выполнения транзакции она изменяет данные, которые были изменены после её начала, то транзакция прерывается с исключением. Использование оптимистичных блокировок позволяет избежать взаимных блокировок (dead-lock). Для реализации оптимистичной блокировки часто используется версионирование данных - в таблицу добавляется колонка, которая хранит текущую версию. При выполнении <tt>update</tt> в запросе в секции <tt>where</tt> передается версия данных, которая была забрана на изменение. Если <tt>update</tt> вернул 0 изменённых строк, значит данные были уже изменены и транзакцию необходимо запускать заново. Вместо версии можно хранить время последнего изменения данных.

<h3>Пессимистичная блокировка</h3>
При пессимистичной блокировке для записи ставится эксклюзивная блокировка на уровне базы данных, запрещая таким образом доступ к данным из других транзакций. Существует несколько видов пессимистичных блокировок:
<ol><li>блокировка при чтении</li><li>блокировка при записи</li></ol>При <span style="font-weight: bold;">блокировке при чтении</span> запись блокируется когда она запрашивается из базы данных. Недостаток метода в том, что таким образом можно заблокировать даже те данные, которые не изменяются в рамках текущей транзакции.

При <span style="font-weight: bold;">блокировке при записи</span> блокировка даных происходит при их обновлении в базе данных до конца текущей транзакции.

Блокировка с данных снимается либо при коммите, либо при откате транзакции.
<h3>
Сравнение оптимистичных и пессимистичных блокировок</h3>
При разработке программного обеспечения необходимо выбирать стратегию блокировок данных. При этом следует учитывать следующее:
<ol><li>Если ситуация обновления одних и тех же данных в один момент времени относительно редка, то выгоднее использовать оптимистичную блокировку. В этом случае не будут происходить дорогая операция блокировки ресурсов.</li><li>Если же возможность возникновения ситуации обновления одних и тех же данных достаточно высока, то лучше использовать пессимистичную блокировку, это снизит количество прерванных транзакций.</li><li>Также следует учитывать, что при оптимистичной блокировке в случае прерывания транзакции её нужно запускать заново.
</li></ol></div>
